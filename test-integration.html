<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clarity - Architecture Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    #text-editor {
      width: 600px;
      height: 400px;
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
      padding: 10px;
      font-family: monospace;
      font-size: 14px;
    }
    #ui-panel {
      margin-top: 20px;
      padding: 20px;
      background: #2a2a2a;
      border: 1px solid #444;
    }
    #debug {
      margin-top: 20px;
      padding: 10px;
      background: #333;
      border: 1px solid #555;
      max-height: 300px;
      overflow-y: auto;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      background: #4a9eff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #3a8eef;
    }
    .error {
      color: #ff6b6b;
    }
    .success {
      color: #51cf66;
    }
    .controls-section {
      margin-bottom: 20px;
      padding: 10px;
      background: #333;
      border: 1px solid #555;
    }
    .controls-section h2 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #4a9eff;
    }
    .slider-container {
      margin: 5px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .slider-container label {
      min-width: 150px;
    }
  </style>
</head>
<body>
  <h1>Clarity - Architecture Test</h1>

  <h2>Document</h2>
  <textarea id="text-editor" spellcheck="false">
# Example instrument

variable vibrato_depth = 30
variable vibrato_rate = 5

oscillator lead
  wave sawtooth
  octave 0
  volume 70
  pitch vibrato

oscillator bass
  wave sine
  octave -1
  volume 50

lfo vibrato
  rate vibrato_rate
  depth vibrato_depth
  wave sine

envelope filter_env
  attack 100
  decay 300
  sustain 70
  release 500

filter main
  frequency 2000
  resonance 5

compressor main_comp
  threshold -20
  ratio 4
  knee 30

master
  volume 80
  attack 10
  release 500
  filter main
  compressor main_comp

note c4
  variable vibrato_depth = 50

key a
  variable vibrato_depth = 100
  </textarea>

  <button onclick="parseDocument()">Parse Document</button>
  <button onclick="playTestNote()">Play Test Note (C4)</button>
  <button onclick="stopAllNotes()">Stop All Notes</button>

  <h2>Generated UI</h2>
  <div id="ui-panel"></div>

  <h2>Debug Output</h2>
  <div id="debug"></div>

  <script src="chords.js"></script>
  <script src="schemas.js"></script>
  <script src="instance-store.js"></script>
  <script src="parser.js"></script>
  <script src="audio-engine.js"></script>
  <script src="ui-generator.js"></script>

  <script>
    let audioContext;
    let debugDiv;

    function log(message, type = 'info') {
      const debugDiv = document.getElementById('debug');
      const line = document.createElement('div');
      line.className = type;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      debugDiv.appendChild(line);
      debugDiv.scrollTop = debugDiv.scrollHeight;
      console.log(message);
    }

    function initializeEverything() {
      log('Initializing systems...');

      // Initialize chord values
      initializeChordValues();
      log('Chord values initialized', 'success');

      // Create audio context
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      log('Audio context created', 'success');

      // Initialize parser
      initializeParser();
      log('Parser initialized', 'success');

      // Initialize UI generator
      initializeUIGenerator();
      log('UI generator initialized', 'success');

      // Initialize audio engine
      initializeAudioEngine(audioContext);
      log('Audio engine initialized', 'success');

      log('All systems ready!', 'success');
    }

    function parseDocument() {
      const text = document.getElementById('text-editor').value;
      log('Parsing document...');

      const result = parser.parse(text);

      if (result.success) {
        log(`Parse successful!`, 'success');
      } else {
        log(`Parse failed with ${result.errors.length} errors`, 'error');
        result.errors.forEach(err => {
          log(`  Line ${err.line}: ${err.message}`, 'error');
        });
      }

      if (result.warnings.length > 0) {
        log(`${result.warnings.length} warnings:`, 'warning');
        result.warnings.forEach(warn => {
          log(`  Line ${warn.line}: ${warn.message}`, 'warning');
        });
      }

      // Debug: Print store state
      log('Instance store state:');
      instanceStore.debug();

      // Generate UI
      log('Generating UI...');
      const uiPanel = document.getElementById('ui-panel');
      uiGenerator.generateUI(uiPanel);
      log('UI generated', 'success');
    }

    function playTestNote() {
      if (!audioEngine) {
        log('Audio engine not initialized!', 'error');
        return;
      }

      // Resume audio context (needed for Chrome)
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }

      log('Playing test note (C4 = 261.63 Hz)');
      const note = audioEngine.createNote('c4', 261.63);

      // Stop after 2 seconds
      setTimeout(() => {
        audioEngine.stopNote(note);
        log('Note stopped');
      }, 2000);
    }

    function stopAllNotes() {
      if (!audioEngine) {
        log('Audio engine not initialized!', 'error');
        return;
      }

      audioEngine.stopAllNotes();
      log('All notes stopped');
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      initializeEverything();
      parseDocument(); // Auto-parse the example
    });
  </script>
</body>
</html>
